
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <title>rdflib.plugins.sparql.operators &#8212; rdflib 6.2.0-alpha documentation</title>

<meta name="viewport" content="width=device-width; initial-scale=1.0; maximum-scale=1.0; user-scalable=0;"/>


    <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/rtd.css" />
    <script data-url_root="../../../../" id="documentation_options" src="../../../../_static/documentation_options.js"></script>
    <script src="../../../../_static/jquery.js"></script>
    <script src="../../../../_static/underscore.js"></script>
    <script src="../../../../_static/doctools.js"></script>
    <script src="../../../../../../../../_static/searchtools.js"></script>
    <link rel="shortcut icon" href="../../../../_static/RDFlib.ico"/>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../../index.html">rdflib 6.2.0-alpha documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../../index.html" accesskey="U">Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">rdflib.plugins.sparql.operators</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for rdflib.plugins.sparql.operators</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">This contains evaluation functions for expressions</span>

<span class="sd">They get bound as instances-methods to the CompValue objects from parserutils</span>
<span class="sd">using setEvalFn</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">uuid</span>
<span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">import</span> <span class="nn">datetime</span> <span class="k">as</span> <span class="nn">py_datetime</span>  <span class="c1"># naming conflict with function within this module</span>

<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">reduce</span>

<span class="kn">from</span> <span class="nn">decimal</span> <span class="kn">import</span> <span class="n">Decimal</span><span class="p">,</span> <span class="n">ROUND_HALF_UP</span><span class="p">,</span> <span class="n">InvalidOperation</span>

<span class="kn">import</span> <span class="nn">operator</span> <span class="k">as</span> <span class="nn">pyop</span>  <span class="c1"># python operators</span>

<span class="kn">import</span> <span class="nn">isodate</span>

<span class="kn">from</span> <span class="nn">rdflib.plugins.sparql.parserutils</span> <span class="kn">import</span> <span class="n">CompValue</span><span class="p">,</span> <span class="n">Expr</span>
<span class="kn">from</span> <span class="nn">rdflib.plugins.sparql.datatypes</span> <span class="kn">import</span> <span class="n">XSD_DTs</span><span class="p">,</span> <span class="n">type_promotion</span>
<span class="kn">from</span> <span class="nn">rdflib.plugins.sparql.datatypes</span> <span class="kn">import</span> <span class="n">XSD_DateTime_DTs</span><span class="p">,</span> <span class="n">XSD_Duration_DTs</span>
<span class="kn">from</span> <span class="nn">rdflib</span> <span class="kn">import</span> <span class="n">URIRef</span><span class="p">,</span> <span class="n">BNode</span><span class="p">,</span> <span class="n">Variable</span><span class="p">,</span> <span class="n">Literal</span><span class="p">,</span> <span class="n">XSD</span><span class="p">,</span> <span class="n">RDF</span>
<span class="kn">from</span> <span class="nn">rdflib.term</span> <span class="kn">import</span> <span class="n">Node</span>

<span class="kn">from</span> <span class="nn">urllib.parse</span> <span class="kn">import</span> <span class="n">quote</span>

<span class="kn">from</span> <span class="nn">pyparsing</span> <span class="kn">import</span> <span class="n">ParseResults</span>

<span class="kn">from</span> <span class="nn">rdflib.plugins.sparql.sparql</span> <span class="kn">import</span> <span class="n">SPARQLError</span><span class="p">,</span> <span class="n">SPARQLTypeError</span>


<div class="viewcode-block" id="Builtin_IRI"><a class="viewcode-back" href="../../../../apidocs/rdflib.plugins.sparql.html#rdflib.plugins.sparql.operators.Builtin_IRI">[docs]</a><span class="k">def</span> <span class="nf">Builtin_IRI</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    http://www.w3.org/TR/sparql11-query/#func-iri</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">a</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">arg</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">URIRef</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">a</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">Literal</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">ctx</span><span class="o">.</span><span class="n">prologue</span><span class="o">.</span><span class="n">absolutize</span><span class="p">(</span><span class="n">URIRef</span><span class="p">(</span><span class="n">a</span><span class="p">))</span>

    <span class="k">raise</span> <span class="n">SPARQLError</span><span class="p">(</span><span class="s2">&quot;IRI function only accepts URIRefs or Literals/Strings!&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Builtin_isBLANK"><a class="viewcode-back" href="../../../../apidocs/rdflib.plugins.sparql.html#rdflib.plugins.sparql.operators.Builtin_isBLANK">[docs]</a><span class="k">def</span> <span class="nf">Builtin_isBLANK</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">Literal</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">arg</span><span class="p">,</span> <span class="n">BNode</span><span class="p">))</span></div>


<div class="viewcode-block" id="Builtin_isLITERAL"><a class="viewcode-back" href="../../../../apidocs/rdflib.plugins.sparql.html#rdflib.plugins.sparql.operators.Builtin_isLITERAL">[docs]</a><span class="k">def</span> <span class="nf">Builtin_isLITERAL</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">Literal</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">arg</span><span class="p">,</span> <span class="n">Literal</span><span class="p">))</span></div>


<div class="viewcode-block" id="Builtin_isIRI"><a class="viewcode-back" href="../../../../apidocs/rdflib.plugins.sparql.html#rdflib.plugins.sparql.operators.Builtin_isIRI">[docs]</a><span class="k">def</span> <span class="nf">Builtin_isIRI</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">Literal</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">arg</span><span class="p">,</span> <span class="n">URIRef</span><span class="p">))</span></div>


<div class="viewcode-block" id="Builtin_isNUMERIC"><a class="viewcode-back" href="../../../../apidocs/rdflib.plugins.sparql.html#rdflib.plugins.sparql.operators.Builtin_isNUMERIC">[docs]</a><span class="k">def</span> <span class="nf">Builtin_isNUMERIC</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">numeric</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">arg</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Literal</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">Literal</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span></div>


<div class="viewcode-block" id="Builtin_BNODE"><a class="viewcode-back" href="../../../../apidocs/rdflib.plugins.sparql.html#rdflib.plugins.sparql.operators.Builtin_BNODE">[docs]</a><span class="k">def</span> <span class="nf">Builtin_BNODE</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    http://www.w3.org/TR/sparql11-query/#func-bnode</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">a</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">arg</span>

    <span class="k">if</span> <span class="n">a</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">BNode</span><span class="p">()</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">Literal</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">ctx</span><span class="o">.</span><span class="n">bnodes</span><span class="p">[</span><span class="n">a</span><span class="p">]</span>  <span class="c1"># defaultdict does the right thing</span>

    <span class="k">raise</span> <span class="n">SPARQLError</span><span class="p">(</span><span class="s2">&quot;BNode function only accepts no argument or literal/string&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Builtin_ABS"><a class="viewcode-back" href="../../../../apidocs/rdflib.plugins.sparql.html#rdflib.plugins.sparql.operators.Builtin_ABS">[docs]</a><span class="k">def</span> <span class="nf">Builtin_ABS</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    http://www.w3.org/TR/sparql11-query/#func-abs</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="n">Literal</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">numeric</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">arg</span><span class="p">)))</span></div>


<div class="viewcode-block" id="Builtin_IF"><a class="viewcode-back" href="../../../../apidocs/rdflib.plugins.sparql.html#rdflib.plugins.sparql.operators.Builtin_IF">[docs]</a><span class="k">def</span> <span class="nf">Builtin_IF</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    http://www.w3.org/TR/sparql11-query/#func-if</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="n">expr</span><span class="o">.</span><span class="n">arg2</span> <span class="k">if</span> <span class="n">EBV</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">arg1</span><span class="p">)</span> <span class="k">else</span> <span class="n">expr</span><span class="o">.</span><span class="n">arg3</span></div>


<div class="viewcode-block" id="Builtin_RAND"><a class="viewcode-back" href="../../../../apidocs/rdflib.plugins.sparql.html#rdflib.plugins.sparql.operators.Builtin_RAND">[docs]</a><span class="k">def</span> <span class="nf">Builtin_RAND</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    http://www.w3.org/TR/sparql11-query/#idp2133952</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="n">Literal</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">())</span></div>


<div class="viewcode-block" id="Builtin_UUID"><a class="viewcode-back" href="../../../../apidocs/rdflib.plugins.sparql.html#rdflib.plugins.sparql.operators.Builtin_UUID">[docs]</a><span class="k">def</span> <span class="nf">Builtin_UUID</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    http://www.w3.org/TR/sparql11-query/#func-strdt</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="n">URIRef</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span><span class="o">.</span><span class="n">urn</span><span class="p">)</span></div>


<div class="viewcode-block" id="Builtin_STRUUID"><a class="viewcode-back" href="../../../../apidocs/rdflib.plugins.sparql.html#rdflib.plugins.sparql.operators.Builtin_STRUUID">[docs]</a><span class="k">def</span> <span class="nf">Builtin_STRUUID</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    http://www.w3.org/TR/sparql11-query/#func-strdt</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="n">Literal</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()))</span></div>


<div class="viewcode-block" id="Builtin_MD5"><a class="viewcode-back" href="../../../../apidocs/rdflib.plugins.sparql.html#rdflib.plugins.sparql.operators.Builtin_MD5">[docs]</a><span class="k">def</span> <span class="nf">Builtin_MD5</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">string</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">arg</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">Literal</span><span class="p">(</span><span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">())</span></div>


<div class="viewcode-block" id="Builtin_SHA1"><a class="viewcode-back" href="../../../../apidocs/rdflib.plugins.sparql.html#rdflib.plugins.sparql.operators.Builtin_SHA1">[docs]</a><span class="k">def</span> <span class="nf">Builtin_SHA1</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">string</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">arg</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">Literal</span><span class="p">(</span><span class="n">hashlib</span><span class="o">.</span><span class="n">sha1</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">())</span></div>


<div class="viewcode-block" id="Builtin_SHA256"><a class="viewcode-back" href="../../../../apidocs/rdflib.plugins.sparql.html#rdflib.plugins.sparql.operators.Builtin_SHA256">[docs]</a><span class="k">def</span> <span class="nf">Builtin_SHA256</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">string</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">arg</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">Literal</span><span class="p">(</span><span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">())</span></div>


<div class="viewcode-block" id="Builtin_SHA384"><a class="viewcode-back" href="../../../../apidocs/rdflib.plugins.sparql.html#rdflib.plugins.sparql.operators.Builtin_SHA384">[docs]</a><span class="k">def</span> <span class="nf">Builtin_SHA384</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">string</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">arg</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">Literal</span><span class="p">(</span><span class="n">hashlib</span><span class="o">.</span><span class="n">sha384</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">())</span></div>


<div class="viewcode-block" id="Builtin_SHA512"><a class="viewcode-back" href="../../../../apidocs/rdflib.plugins.sparql.html#rdflib.plugins.sparql.operators.Builtin_SHA512">[docs]</a><span class="k">def</span> <span class="nf">Builtin_SHA512</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">string</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">arg</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">Literal</span><span class="p">(</span><span class="n">hashlib</span><span class="o">.</span><span class="n">sha512</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">())</span></div>


<div class="viewcode-block" id="Builtin_COALESCE"><a class="viewcode-back" href="../../../../apidocs/rdflib.plugins.sparql.html#rdflib.plugins.sparql.operators.Builtin_COALESCE">[docs]</a><span class="k">def</span> <span class="nf">Builtin_COALESCE</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    http://www.w3.org/TR/sparql11-query/#func-coalesce</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">expr</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;arg&quot;</span><span class="p">,</span> <span class="n">variables</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">(</span><span class="n">SPARQLError</span><span class="p">,</span> <span class="n">Variable</span><span class="p">)):</span>
            <span class="k">return</span> <span class="n">x</span>
    <span class="k">raise</span> <span class="n">SPARQLError</span><span class="p">(</span><span class="s2">&quot;COALESCE got no arguments that did not evaluate to an error&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Builtin_CEIL"><a class="viewcode-back" href="../../../../apidocs/rdflib.plugins.sparql.html#rdflib.plugins.sparql.operators.Builtin_CEIL">[docs]</a><span class="k">def</span> <span class="nf">Builtin_CEIL</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    http://www.w3.org/TR/sparql11-query/#func-ceil</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">l_</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">arg</span>
    <span class="k">return</span> <span class="n">Literal</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">numeric</span><span class="p">(</span><span class="n">l_</span><span class="p">))),</span> <span class="n">datatype</span><span class="o">=</span><span class="n">l_</span><span class="o">.</span><span class="n">datatype</span><span class="p">)</span></div>


<div class="viewcode-block" id="Builtin_FLOOR"><a class="viewcode-back" href="../../../../apidocs/rdflib.plugins.sparql.html#rdflib.plugins.sparql.operators.Builtin_FLOOR">[docs]</a><span class="k">def</span> <span class="nf">Builtin_FLOOR</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    http://www.w3.org/TR/sparql11-query/#func-floor</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">l_</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">arg</span>
    <span class="k">return</span> <span class="n">Literal</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">numeric</span><span class="p">(</span><span class="n">l_</span><span class="p">))),</span> <span class="n">datatype</span><span class="o">=</span><span class="n">l_</span><span class="o">.</span><span class="n">datatype</span><span class="p">)</span></div>


<div class="viewcode-block" id="Builtin_ROUND"><a class="viewcode-back" href="../../../../apidocs/rdflib.plugins.sparql.html#rdflib.plugins.sparql.operators.Builtin_ROUND">[docs]</a><span class="k">def</span> <span class="nf">Builtin_ROUND</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    http://www.w3.org/TR/sparql11-query/#func-round</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># This used to be just math.bound</span>
    <span class="c1"># but in py3k bound was changed to</span>
    <span class="c1"># &quot;round-to-even&quot; behaviour</span>
    <span class="c1"># this is an ugly work-around</span>
    <span class="n">l_</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">arg</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">numeric</span><span class="p">(</span><span class="n">l_</span><span class="p">)</span>
    <span class="n">v</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">.</span><span class="n">quantize</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">ROUND_HALF_UP</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">Literal</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">datatype</span><span class="o">=</span><span class="n">l_</span><span class="o">.</span><span class="n">datatype</span><span class="p">)</span></div>


<div class="viewcode-block" id="Builtin_REGEX"><a class="viewcode-back" href="../../../../apidocs/rdflib.plugins.sparql.html#rdflib.plugins.sparql.operators.Builtin_REGEX">[docs]</a><span class="k">def</span> <span class="nf">Builtin_REGEX</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    http://www.w3.org/TR/sparql11-query/#func-regex</span>
<span class="sd">    Invokes the XPath fn:matches function to match text against a regular</span>
<span class="sd">    expression pattern.</span>
<span class="sd">    The regular expression language is defined in XQuery 1.0 and XPath 2.0</span>
<span class="sd">    Functions and Operators section 7.6.1 Regular Expression Syntax</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">text</span> <span class="o">=</span> <span class="n">string</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
    <span class="n">pattern</span> <span class="o">=</span> <span class="n">string</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">pattern</span><span class="p">)</span>
    <span class="n">flags</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">flags</span>

    <span class="n">cFlag</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">flags</span><span class="p">:</span>
        <span class="c1"># Maps XPath REGEX flags (http://www.w3.org/TR/xpath-functions/#flags)</span>
        <span class="c1"># to Python&#39;s re flags</span>
        <span class="n">flagMap</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([(</span><span class="s2">&quot;i&quot;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;s&quot;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;m&quot;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span><span class="p">)])</span>
        <span class="n">cFlag</span> <span class="o">=</span> <span class="n">reduce</span><span class="p">(</span><span class="n">pyop</span><span class="o">.</span><span class="n">or_</span><span class="p">,</span> <span class="p">[</span><span class="n">flagMap</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">flags</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">Literal</span><span class="p">(</span><span class="nb">bool</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">pattern</span><span class="p">),</span> <span class="n">text</span><span class="p">,</span> <span class="n">cFlag</span><span class="p">)))</span></div>


<div class="viewcode-block" id="Builtin_REPLACE"><a class="viewcode-back" href="../../../../apidocs/rdflib.plugins.sparql.html#rdflib.plugins.sparql.operators.Builtin_REPLACE">[docs]</a><span class="k">def</span> <span class="nf">Builtin_REPLACE</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    http://www.w3.org/TR/sparql11-query/#func-substr</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">string</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">arg</span><span class="p">)</span>
    <span class="n">pattern</span> <span class="o">=</span> <span class="n">string</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">pattern</span><span class="p">)</span>
    <span class="n">replacement</span> <span class="o">=</span> <span class="n">string</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">replacement</span><span class="p">)</span>
    <span class="n">flags</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">flags</span>

    <span class="c1"># python uses \1, xpath/sparql uses $1</span>
    <span class="n">replacement</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">$([0-9]*)&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">\1&quot;</span><span class="p">,</span> <span class="n">replacement</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_r</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>

        <span class="c1"># Now this is ugly.</span>
        <span class="c1"># Python has a &quot;feature&quot; where unmatched groups return None</span>
        <span class="c1"># then re.sub chokes on this.</span>
        <span class="c1"># see http://bugs.python.org/issue1519638 , fixed and errs in py3.5</span>

        <span class="c1"># this works around and hooks into the internal of the re module...</span>

        <span class="c1"># the match object is replaced with a wrapper that</span>
        <span class="c1"># returns &quot;&quot; instead of None for unmatched groups</span>

        <span class="k">class</span> <span class="nc">_m</span><span class="p">:</span>
            <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">m</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="o">=</span> <span class="n">m</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">string</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">string</span>

            <span class="k">def</span> <span class="nf">group</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span>

        <span class="k">return</span> <span class="n">re</span><span class="o">.</span><span class="n">_expand</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">_m</span><span class="p">(</span><span class="n">m</span><span class="p">),</span> <span class="n">replacement</span><span class="p">)</span>

    <span class="n">cFlag</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">flags</span><span class="p">:</span>
        <span class="c1"># Maps XPath REGEX flags (http://www.w3.org/TR/xpath-functions/#flags)</span>
        <span class="c1"># to Python&#39;s re flags</span>
        <span class="n">flagMap</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([(</span><span class="s2">&quot;i&quot;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;s&quot;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;m&quot;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span><span class="p">)])</span>
        <span class="n">cFlag</span> <span class="o">=</span> <span class="n">reduce</span><span class="p">(</span><span class="n">pyop</span><span class="o">.</span><span class="n">or_</span><span class="p">,</span> <span class="p">[</span><span class="n">flagMap</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">flags</span><span class="p">])</span>

        <span class="c1"># @@FIXME@@ either datatype OR lang, NOT both</span>

    <span class="c1"># this is necessary due to different treatment of unmatched groups in</span>
    <span class="c1"># python versions. see comments above in _r(m).</span>
    <span class="n">compat_r</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">replacement</span><span class="p">)</span> <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="k">else</span> <span class="n">_r</span>

    <span class="k">return</span> <span class="n">Literal</span><span class="p">(</span>
        <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">pattern</span><span class="p">),</span> <span class="n">compat_r</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">cFlag</span><span class="p">),</span>
        <span class="n">datatype</span><span class="o">=</span><span class="n">text</span><span class="o">.</span><span class="n">datatype</span><span class="p">,</span>
        <span class="n">lang</span><span class="o">=</span><span class="n">text</span><span class="o">.</span><span class="n">language</span><span class="p">,</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="Builtin_STRDT"><a class="viewcode-back" href="../../../../apidocs/rdflib.plugins.sparql.html#rdflib.plugins.sparql.operators.Builtin_STRDT">[docs]</a><span class="k">def</span> <span class="nf">Builtin_STRDT</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    http://www.w3.org/TR/sparql11-query/#func-strdt</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="n">Literal</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">arg1</span><span class="p">),</span> <span class="n">datatype</span><span class="o">=</span><span class="n">expr</span><span class="o">.</span><span class="n">arg2</span><span class="p">)</span></div>


<div class="viewcode-block" id="Builtin_STRLANG"><a class="viewcode-back" href="../../../../apidocs/rdflib.plugins.sparql.html#rdflib.plugins.sparql.operators.Builtin_STRLANG">[docs]</a><span class="k">def</span> <span class="nf">Builtin_STRLANG</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    http://www.w3.org/TR/sparql11-query/#func-strlang</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">s</span> <span class="o">=</span> <span class="n">string</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">arg1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">language</span> <span class="ow">or</span> <span class="n">s</span><span class="o">.</span><span class="n">datatype</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">SPARQLError</span><span class="p">(</span><span class="s2">&quot;STRLANG expects a simple literal&quot;</span><span class="p">)</span>

    <span class="c1"># TODO: normalisation of lang tag to lower-case</span>
    <span class="c1"># should probably happen in literal __init__</span>
    <span class="k">return</span> <span class="n">Literal</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">s</span><span class="p">),</span> <span class="n">lang</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">arg2</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span></div>


<div class="viewcode-block" id="Builtin_CONCAT"><a class="viewcode-back" href="../../../../apidocs/rdflib.plugins.sparql.html#rdflib.plugins.sparql.operators.Builtin_CONCAT">[docs]</a><span class="k">def</span> <span class="nf">Builtin_CONCAT</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    http://www.w3.org/TR/sparql11-query/#func-concat</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># dt/lang passed on only if they all match</span>

    <span class="n">dt</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">datatype</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">expr</span><span class="o">.</span><span class="n">arg</span><span class="p">)</span>
    <span class="n">dt</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="kc">None</span>

    <span class="n">lang</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">language</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">expr</span><span class="o">.</span><span class="n">arg</span><span class="p">)</span>
    <span class="n">lang</span> <span class="o">=</span> <span class="n">lang</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lang</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="n">Literal</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">string</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">expr</span><span class="o">.</span><span class="n">arg</span><span class="p">),</span> <span class="n">datatype</span><span class="o">=</span><span class="n">dt</span><span class="p">,</span> <span class="n">lang</span><span class="o">=</span><span class="n">lang</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">_compatibleStrings</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="n">string</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="n">string</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">b</span><span class="o">.</span><span class="n">language</span> <span class="ow">and</span> <span class="n">a</span><span class="o">.</span><span class="n">language</span> <span class="o">!=</span> <span class="n">b</span><span class="o">.</span><span class="n">language</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">SPARQLError</span><span class="p">(</span><span class="s2">&quot;incompatible arguments to str functions&quot;</span><span class="p">)</span>


<div class="viewcode-block" id="Builtin_STRSTARTS"><a class="viewcode-back" href="../../../../apidocs/rdflib.plugins.sparql.html#rdflib.plugins.sparql.operators.Builtin_STRSTARTS">[docs]</a><span class="k">def</span> <span class="nf">Builtin_STRSTARTS</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    http://www.w3.org/TR/sparql11-query/#func-strstarts</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">a</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">arg1</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">arg2</span>
    <span class="n">_compatibleStrings</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">Literal</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">b</span><span class="p">))</span></div>


<div class="viewcode-block" id="Builtin_STRENDS"><a class="viewcode-back" href="../../../../apidocs/rdflib.plugins.sparql.html#rdflib.plugins.sparql.operators.Builtin_STRENDS">[docs]</a><span class="k">def</span> <span class="nf">Builtin_STRENDS</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    http://www.w3.org/TR/sparql11-query/#func-strends</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">arg1</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">arg2</span>

    <span class="n">_compatibleStrings</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">Literal</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">b</span><span class="p">))</span></div>


<div class="viewcode-block" id="Builtin_STRBEFORE"><a class="viewcode-back" href="../../../../apidocs/rdflib.plugins.sparql.html#rdflib.plugins.sparql.operators.Builtin_STRBEFORE">[docs]</a><span class="k">def</span> <span class="nf">Builtin_STRBEFORE</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    http://www.w3.org/TR/sparql11-query/#func-strbefore</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">a</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">arg1</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">arg2</span>
    <span class="n">_compatibleStrings</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>

    <span class="n">i</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">Literal</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">Literal</span><span class="p">(</span><span class="n">a</span><span class="p">[:</span><span class="n">i</span><span class="p">],</span> <span class="n">lang</span><span class="o">=</span><span class="n">a</span><span class="o">.</span><span class="n">language</span><span class="p">,</span> <span class="n">datatype</span><span class="o">=</span><span class="n">a</span><span class="o">.</span><span class="n">datatype</span><span class="p">)</span></div>


<div class="viewcode-block" id="Builtin_STRAFTER"><a class="viewcode-back" href="../../../../apidocs/rdflib.plugins.sparql.html#rdflib.plugins.sparql.operators.Builtin_STRAFTER">[docs]</a><span class="k">def</span> <span class="nf">Builtin_STRAFTER</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    http://www.w3.org/TR/sparql11-query/#func-strafter</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">a</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">arg1</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">arg2</span>
    <span class="n">_compatibleStrings</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>

    <span class="n">i</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">Literal</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">Literal</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="p">:],</span> <span class="n">lang</span><span class="o">=</span><span class="n">a</span><span class="o">.</span><span class="n">language</span><span class="p">,</span> <span class="n">datatype</span><span class="o">=</span><span class="n">a</span><span class="o">.</span><span class="n">datatype</span><span class="p">)</span></div>


<div class="viewcode-block" id="Builtin_CONTAINS"><a class="viewcode-back" href="../../../../apidocs/rdflib.plugins.sparql.html#rdflib.plugins.sparql.operators.Builtin_CONTAINS">[docs]</a><span class="k">def</span> <span class="nf">Builtin_CONTAINS</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    http://www.w3.org/TR/sparql11-query/#func-strcontains</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">a</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">arg1</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">arg2</span>
    <span class="n">_compatibleStrings</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">Literal</span><span class="p">(</span><span class="n">b</span> <span class="ow">in</span> <span class="n">a</span><span class="p">)</span></div>


<div class="viewcode-block" id="Builtin_ENCODE_FOR_URI"><a class="viewcode-back" href="../../../../apidocs/rdflib.plugins.sparql.html#rdflib.plugins.sparql.operators.Builtin_ENCODE_FOR_URI">[docs]</a><span class="k">def</span> <span class="nf">Builtin_ENCODE_FOR_URI</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">Literal</span><span class="p">(</span><span class="n">quote</span><span class="p">(</span><span class="n">string</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">arg</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)))</span></div>


<div class="viewcode-block" id="Builtin_SUBSTR"><a class="viewcode-back" href="../../../../apidocs/rdflib.plugins.sparql.html#rdflib.plugins.sparql.operators.Builtin_SUBSTR">[docs]</a><span class="k">def</span> <span class="nf">Builtin_SUBSTR</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    http://www.w3.org/TR/sparql11-query/#func-substr</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">a</span> <span class="o">=</span> <span class="n">string</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">arg</span><span class="p">)</span>

    <span class="n">start</span> <span class="o">=</span> <span class="n">numeric</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">start</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>

    <span class="n">length</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">length</span>
    <span class="k">if</span> <span class="n">length</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">length</span> <span class="o">=</span> <span class="n">numeric</span><span class="p">(</span><span class="n">length</span><span class="p">)</span> <span class="o">+</span> <span class="n">start</span>

    <span class="k">return</span> <span class="n">Literal</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">length</span><span class="p">],</span> <span class="n">lang</span><span class="o">=</span><span class="n">a</span><span class="o">.</span><span class="n">language</span><span class="p">,</span> <span class="n">datatype</span><span class="o">=</span><span class="n">a</span><span class="o">.</span><span class="n">datatype</span><span class="p">)</span></div>


<div class="viewcode-block" id="Builtin_STRLEN"><a class="viewcode-back" href="../../../../apidocs/rdflib.plugins.sparql.html#rdflib.plugins.sparql.operators.Builtin_STRLEN">[docs]</a><span class="k">def</span> <span class="nf">Builtin_STRLEN</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>
    <span class="n">l_</span> <span class="o">=</span> <span class="n">string</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">arg</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">Literal</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">l_</span><span class="p">))</span></div>


<div class="viewcode-block" id="Builtin_STR"><a class="viewcode-back" href="../../../../apidocs/rdflib.plugins.sparql.html#rdflib.plugins.sparql.operators.Builtin_STR">[docs]</a><span class="k">def</span> <span class="nf">Builtin_STR</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>
    <span class="n">arg</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">arg</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">SPARQLError</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">arg</span>
    <span class="k">return</span> <span class="n">Literal</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">arg</span><span class="p">))</span>  <span class="c1"># plain literal</span></div>


<div class="viewcode-block" id="Builtin_LCASE"><a class="viewcode-back" href="../../../../apidocs/rdflib.plugins.sparql.html#rdflib.plugins.sparql.operators.Builtin_LCASE">[docs]</a><span class="k">def</span> <span class="nf">Builtin_LCASE</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>
    <span class="n">l_</span> <span class="o">=</span> <span class="n">string</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">arg</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">Literal</span><span class="p">(</span><span class="n">l_</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="n">datatype</span><span class="o">=</span><span class="n">l_</span><span class="o">.</span><span class="n">datatype</span><span class="p">,</span> <span class="n">lang</span><span class="o">=</span><span class="n">l_</span><span class="o">.</span><span class="n">language</span><span class="p">)</span></div>


<div class="viewcode-block" id="Builtin_LANGMATCHES"><a class="viewcode-back" href="../../../../apidocs/rdflib.plugins.sparql.html#rdflib.plugins.sparql.operators.Builtin_LANGMATCHES">[docs]</a><span class="k">def</span> <span class="nf">Builtin_LANGMATCHES</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    http://www.w3.org/TR/sparql11-query/#func-langMatches</span>


<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">langTag</span> <span class="o">=</span> <span class="n">string</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">arg1</span><span class="p">)</span>
    <span class="n">langRange</span> <span class="o">=</span> <span class="n">string</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">arg2</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">langTag</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">Literal</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># nothing matches empty!</span>

    <span class="k">return</span> <span class="n">Literal</span><span class="p">(</span><span class="n">_lang_range_check</span><span class="p">(</span><span class="n">langRange</span><span class="p">,</span> <span class="n">langTag</span><span class="p">))</span></div>


<div class="viewcode-block" id="Builtin_NOW"><a class="viewcode-back" href="../../../../apidocs/rdflib.plugins.sparql.html#rdflib.plugins.sparql.operators.Builtin_NOW">[docs]</a><span class="k">def</span> <span class="nf">Builtin_NOW</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    http://www.w3.org/TR/sparql11-query/#func-now</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">Literal</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">now</span><span class="p">)</span></div>


<div class="viewcode-block" id="Builtin_YEAR"><a class="viewcode-back" href="../../../../apidocs/rdflib.plugins.sparql.html#rdflib.plugins.sparql.operators.Builtin_YEAR">[docs]</a><span class="k">def</span> <span class="nf">Builtin_YEAR</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">date</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">arg</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">Literal</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">year</span><span class="p">)</span></div>


<div class="viewcode-block" id="Builtin_MONTH"><a class="viewcode-back" href="../../../../apidocs/rdflib.plugins.sparql.html#rdflib.plugins.sparql.operators.Builtin_MONTH">[docs]</a><span class="k">def</span> <span class="nf">Builtin_MONTH</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">date</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">arg</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">Literal</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">month</span><span class="p">)</span></div>


<div class="viewcode-block" id="Builtin_DAY"><a class="viewcode-back" href="../../../../apidocs/rdflib.plugins.sparql.html#rdflib.plugins.sparql.operators.Builtin_DAY">[docs]</a><span class="k">def</span> <span class="nf">Builtin_DAY</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">date</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">arg</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">Literal</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">day</span><span class="p">)</span></div>


<div class="viewcode-block" id="Builtin_HOURS"><a class="viewcode-back" href="../../../../apidocs/rdflib.plugins.sparql.html#rdflib.plugins.sparql.operators.Builtin_HOURS">[docs]</a><span class="k">def</span> <span class="nf">Builtin_HOURS</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">arg</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">Literal</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">hour</span><span class="p">)</span></div>


<div class="viewcode-block" id="Builtin_MINUTES"><a class="viewcode-back" href="../../../../apidocs/rdflib.plugins.sparql.html#rdflib.plugins.sparql.operators.Builtin_MINUTES">[docs]</a><span class="k">def</span> <span class="nf">Builtin_MINUTES</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">arg</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">Literal</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">minute</span><span class="p">)</span></div>


<div class="viewcode-block" id="Builtin_SECONDS"><a class="viewcode-back" href="../../../../apidocs/rdflib.plugins.sparql.html#rdflib.plugins.sparql.operators.Builtin_SECONDS">[docs]</a><span class="k">def</span> <span class="nf">Builtin_SECONDS</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    http://www.w3.org/TR/sparql11-query/#func-seconds</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">arg</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">Literal</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">second</span><span class="p">,</span> <span class="n">datatype</span><span class="o">=</span><span class="n">XSD</span><span class="o">.</span><span class="n">decimal</span><span class="p">)</span></div>


<div class="viewcode-block" id="Builtin_TIMEZONE"><a class="viewcode-back" href="../../../../apidocs/rdflib.plugins.sparql.html#rdflib.plugins.sparql.operators.Builtin_TIMEZONE">[docs]</a><span class="k">def</span> <span class="nf">Builtin_TIMEZONE</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    http://www.w3.org/TR/sparql11-query/#func-timezone</span>

<span class="sd">    :returns: the timezone part of arg as an xsd:dayTimeDuration.</span>
<span class="sd">    :raises: an error if there is no timezone.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dt</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">arg</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">dt</span><span class="o">.</span><span class="n">tzinfo</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">SPARQLError</span><span class="p">(</span><span class="s2">&quot;datatime has no timezone: </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">dt</span><span class="p">)</span>

    <span class="n">delta</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">utcoffset</span><span class="p">()</span>

    <span class="n">d</span> <span class="o">=</span> <span class="n">delta</span><span class="o">.</span><span class="n">days</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">delta</span><span class="o">.</span><span class="n">seconds</span>
    <span class="n">neg</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

    <span class="k">if</span> <span class="n">d</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="o">-</span><span class="mi">24</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="n">d</span> <span class="o">-</span> <span class="n">s</span>
        <span class="n">d</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">neg</span> <span class="o">=</span> <span class="s2">&quot;-&quot;</span>

    <span class="n">h</span> <span class="o">=</span> <span class="n">s</span> <span class="o">/</span> <span class="p">(</span><span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
    <span class="n">m</span> <span class="o">=</span> <span class="p">(</span><span class="n">s</span> <span class="o">-</span> <span class="n">h</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span> <span class="o">/</span> <span class="mi">60</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">s</span> <span class="o">-</span> <span class="n">h</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">-</span> <span class="n">m</span> <span class="o">*</span> <span class="mi">60</span>

    <span class="n">tzdelta</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">P</span><span class="si">%s</span><span class="s2">T</span><span class="si">%s%s%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
        <span class="n">neg</span><span class="p">,</span>
        <span class="s2">&quot;</span><span class="si">%d</span><span class="s2">D&quot;</span> <span class="o">%</span> <span class="n">d</span> <span class="k">if</span> <span class="n">d</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;</span><span class="si">%d</span><span class="s2">H&quot;</span> <span class="o">%</span> <span class="n">h</span> <span class="k">if</span> <span class="n">h</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;</span><span class="si">%d</span><span class="s2">M&quot;</span> <span class="o">%</span> <span class="n">m</span> <span class="k">if</span> <span class="n">m</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;</span><span class="si">%d</span><span class="s2">S&quot;</span> <span class="o">%</span> <span class="n">s</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">d</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">h</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">m</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">Literal</span><span class="p">(</span><span class="n">tzdelta</span><span class="p">,</span> <span class="n">datatype</span><span class="o">=</span><span class="n">XSD</span><span class="o">.</span><span class="n">dayTimeDuration</span><span class="p">)</span></div>


<div class="viewcode-block" id="Builtin_TZ"><a class="viewcode-back" href="../../../../apidocs/rdflib.plugins.sparql.html#rdflib.plugins.sparql.operators.Builtin_TZ">[docs]</a><span class="k">def</span> <span class="nf">Builtin_TZ</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">arg</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">d</span><span class="o">.</span><span class="n">tzinfo</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">Literal</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">tzinfo</span><span class="o">.</span><span class="n">tzname</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="s2">&quot;UTC&quot;</span><span class="p">:</span>
        <span class="n">n</span> <span class="o">=</span> <span class="s2">&quot;Z&quot;</span>
    <span class="k">return</span> <span class="n">Literal</span><span class="p">(</span><span class="n">n</span><span class="p">)</span></div>


<div class="viewcode-block" id="Builtin_UCASE"><a class="viewcode-back" href="../../../../apidocs/rdflib.plugins.sparql.html#rdflib.plugins.sparql.operators.Builtin_UCASE">[docs]</a><span class="k">def</span> <span class="nf">Builtin_UCASE</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>
    <span class="n">l_</span> <span class="o">=</span> <span class="n">string</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">arg</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">Literal</span><span class="p">(</span><span class="n">l_</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="n">datatype</span><span class="o">=</span><span class="n">l_</span><span class="o">.</span><span class="n">datatype</span><span class="p">,</span> <span class="n">lang</span><span class="o">=</span><span class="n">l_</span><span class="o">.</span><span class="n">language</span><span class="p">)</span></div>


<div class="viewcode-block" id="Builtin_LANG"><a class="viewcode-back" href="../../../../apidocs/rdflib.plugins.sparql.html#rdflib.plugins.sparql.operators.Builtin_LANG">[docs]</a><span class="k">def</span> <span class="nf">Builtin_LANG</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    http://www.w3.org/TR/sparql11-query/#func-lang</span>

<span class="sd">    Returns the language tag of ltrl, if it has one. It returns &quot;&quot; if ltrl has</span>
<span class="sd">    no language tag. Note that the RDF data model does not include literals</span>
<span class="sd">    with an empty language tag.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">l_</span> <span class="o">=</span> <span class="n">literal</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">arg</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">Literal</span><span class="p">(</span><span class="n">l_</span><span class="o">.</span><span class="n">language</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Builtin_DATATYPE"><a class="viewcode-back" href="../../../../apidocs/rdflib.plugins.sparql.html#rdflib.plugins.sparql.operators.Builtin_DATATYPE">[docs]</a><span class="k">def</span> <span class="nf">Builtin_DATATYPE</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>
    <span class="n">l_</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">arg</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">l_</span><span class="p">,</span> <span class="n">Literal</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">SPARQLError</span><span class="p">(</span><span class="s2">&quot;Can only get datatype of literal: </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">l_</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">l_</span><span class="o">.</span><span class="n">language</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">RDF</span><span class="o">.</span><span class="n">langString</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">l_</span><span class="o">.</span><span class="n">datatype</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">l_</span><span class="o">.</span><span class="n">language</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">XSD</span><span class="o">.</span><span class="n">string</span>
    <span class="k">return</span> <span class="n">l_</span><span class="o">.</span><span class="n">datatype</span></div>


<div class="viewcode-block" id="Builtin_sameTerm"><a class="viewcode-back" href="../../../../apidocs/rdflib.plugins.sparql.html#rdflib.plugins.sparql.operators.Builtin_sameTerm">[docs]</a><span class="k">def</span> <span class="nf">Builtin_sameTerm</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">arg1</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">arg2</span>
    <span class="k">return</span> <span class="n">Literal</span><span class="p">(</span><span class="n">a</span> <span class="o">==</span> <span class="n">b</span><span class="p">)</span></div>


<div class="viewcode-block" id="Builtin_BOUND"><a class="viewcode-back" href="../../../../apidocs/rdflib.plugins.sparql.html#rdflib.plugins.sparql.operators.Builtin_BOUND">[docs]</a><span class="k">def</span> <span class="nf">Builtin_BOUND</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    http://www.w3.org/TR/sparql11-query/#func-bound</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;arg&quot;</span><span class="p">,</span> <span class="n">variables</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">Literal</span><span class="p">(</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">Variable</span><span class="p">))</span></div>


<div class="viewcode-block" id="Builtin_EXISTS"><a class="viewcode-back" href="../../../../apidocs/rdflib.plugins.sparql.html#rdflib.plugins.sparql.operators.Builtin_EXISTS">[docs]</a><span class="k">def</span> <span class="nf">Builtin_EXISTS</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>
    <span class="c1"># damn...</span>
    <span class="kn">from</span> <span class="nn">rdflib.plugins.sparql.evaluate</span> <span class="kn">import</span> <span class="n">evalPart</span>

    <span class="n">exists</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;Builtin_EXISTS&quot;</span>

    <span class="n">ctx</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">ctx</span><span class="o">.</span><span class="n">thaw</span><span class="p">(</span><span class="n">ctx</span><span class="p">)</span>  <span class="c1"># hmm</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">evalPart</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">graph</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Literal</span><span class="p">(</span><span class="n">exists</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">Literal</span><span class="p">(</span><span class="ow">not</span> <span class="n">exists</span><span class="p">)</span></div>


<span class="n">_CUSTOM_FUNCTIONS</span> <span class="o">=</span> <span class="p">{}</span>


<div class="viewcode-block" id="register_custom_function"><a class="viewcode-back" href="../../../../apidocs/rdflib.plugins.sparql.html#rdflib.plugins.sparql.operators.register_custom_function">[docs]</a><span class="k">def</span> <span class="nf">register_custom_function</span><span class="p">(</span><span class="n">uri</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">override</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">raw</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Register a custom SPARQL function.</span>

<span class="sd">    By default, the function will be passed the RDF terms in the argument list.</span>
<span class="sd">    If raw is True, the function will be passed an Expression and a Context.</span>

<span class="sd">    The function must return an RDF term, or raise a SparqlError.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">override</span> <span class="ow">and</span> <span class="n">uri</span> <span class="ow">in</span> <span class="n">_CUSTOM_FUNCTIONS</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;A function is already registered as </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">uri</span><span class="o">.</span><span class="n">n3</span><span class="p">())</span>
    <span class="n">_CUSTOM_FUNCTIONS</span><span class="p">[</span><span class="n">uri</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">raw</span><span class="p">)</span></div>


<div class="viewcode-block" id="custom_function"><a class="viewcode-back" href="../../../../apidocs/rdflib.plugins.sparql.html#rdflib.plugins.sparql.operators.custom_function">[docs]</a><span class="k">def</span> <span class="nf">custom_function</span><span class="p">(</span><span class="n">uri</span><span class="p">,</span> <span class="n">override</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">raw</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Decorator version of :func:`register_custom_function`.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">decorator</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
        <span class="n">register_custom_function</span><span class="p">(</span><span class="n">uri</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">override</span><span class="o">=</span><span class="n">override</span><span class="p">,</span> <span class="n">raw</span><span class="o">=</span><span class="n">raw</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">func</span>

    <span class="k">return</span> <span class="n">decorator</span></div>


<div class="viewcode-block" id="unregister_custom_function"><a class="viewcode-back" href="../../../../apidocs/rdflib.plugins.sparql.html#rdflib.plugins.sparql.operators.unregister_custom_function">[docs]</a><span class="k">def</span> <span class="nf">unregister_custom_function</span><span class="p">(</span><span class="n">uri</span><span class="p">,</span> <span class="n">func</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">_CUSTOM_FUNCTIONS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">uri</span><span class="p">,</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">func</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;This function is not registered as </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">uri</span><span class="o">.</span><span class="n">n3</span><span class="p">())</span>
    <span class="k">del</span> <span class="n">_CUSTOM_FUNCTIONS</span><span class="p">[</span><span class="n">uri</span><span class="p">]</span></div>


<div class="viewcode-block" id="Function"><a class="viewcode-back" href="../../../../apidocs/rdflib.plugins.sparql.html#rdflib.plugins.sparql.operators.Function">[docs]</a><span class="k">def</span> <span class="nf">Function</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Custom functions and casts</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">pair</span> <span class="o">=</span> <span class="n">_CUSTOM_FUNCTIONS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">iri</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">pair</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># no such function is registered</span>
        <span class="k">raise</span> <span class="n">SPARQLError</span><span class="p">(</span><span class="s2">&quot;Unknown function </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">e</span><span class="o">.</span><span class="n">iri</span><span class="p">)</span>
    <span class="n">func</span><span class="p">,</span> <span class="n">raw</span> <span class="o">=</span> <span class="n">pair</span>
    <span class="k">if</span> <span class="n">raw</span><span class="p">:</span>
        <span class="c1"># function expects expression and context</span>
        <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">ctx</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># function expects the argument list</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">e</span><span class="o">.</span><span class="n">expr</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">TypeError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="c1"># wrong argument number</span>
            <span class="k">raise</span> <span class="n">SPARQLError</span><span class="p">(</span><span class="o">*</span><span class="n">ex</span><span class="o">.</span><span class="n">args</span><span class="p">)</span></div>


<div class="viewcode-block" id="default_cast"><a class="viewcode-back" href="../../../../apidocs/rdflib.plugins.sparql.html#rdflib.plugins.sparql.operators.default_cast">[docs]</a><span class="nd">@custom_function</span><span class="p">(</span><span class="n">XSD</span><span class="o">.</span><span class="n">string</span><span class="p">,</span> <span class="n">raw</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@custom_function</span><span class="p">(</span><span class="n">XSD</span><span class="o">.</span><span class="n">dateTime</span><span class="p">,</span> <span class="n">raw</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@custom_function</span><span class="p">(</span><span class="n">XSD</span><span class="o">.</span><span class="n">float</span><span class="p">,</span> <span class="n">raw</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@custom_function</span><span class="p">(</span><span class="n">XSD</span><span class="o">.</span><span class="n">double</span><span class="p">,</span> <span class="n">raw</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@custom_function</span><span class="p">(</span><span class="n">XSD</span><span class="o">.</span><span class="n">decimal</span><span class="p">,</span> <span class="n">raw</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@custom_function</span><span class="p">(</span><span class="n">XSD</span><span class="o">.</span><span class="n">integer</span><span class="p">,</span> <span class="n">raw</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@custom_function</span><span class="p">(</span><span class="n">XSD</span><span class="o">.</span><span class="n">boolean</span><span class="p">,</span> <span class="n">raw</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">default_cast</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">e</span><span class="o">.</span><span class="n">expr</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">SPARQLError</span><span class="p">(</span><span class="s2">&quot;Nothing given to cast.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">expr</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">SPARQLError</span><span class="p">(</span><span class="s2">&quot;Cannot cast more than one thing!&quot;</span><span class="p">)</span>

    <span class="n">x</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">expr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">iri</span> <span class="o">==</span> <span class="n">XSD</span><span class="o">.</span><span class="n">string</span><span class="p">:</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">(</span><span class="n">URIRef</span><span class="p">,</span> <span class="n">Literal</span><span class="p">)):</span>
            <span class="k">return</span> <span class="n">Literal</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">datatype</span><span class="o">=</span><span class="n">XSD</span><span class="o">.</span><span class="n">string</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SPARQLError</span><span class="p">(</span><span class="s2">&quot;Cannot cast term </span><span class="si">%r</span><span class="s2"> of type </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">Literal</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">SPARQLError</span><span class="p">(</span><span class="s2">&quot;Can only cast Literals to non-string data-types&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">datatype</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">x</span><span class="o">.</span><span class="n">datatype</span> <span class="ow">in</span> <span class="n">XSD_DTs</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">SPARQLError</span><span class="p">(</span><span class="s2">&quot;Cannot cast literal with unknown datatype: </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">x</span><span class="o">.</span><span class="n">datatype</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">iri</span> <span class="o">==</span> <span class="n">XSD</span><span class="o">.</span><span class="n">dateTime</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">datatype</span> <span class="ow">and</span> <span class="n">x</span><span class="o">.</span><span class="n">datatype</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="n">XSD</span><span class="o">.</span><span class="n">dateTime</span><span class="p">,</span> <span class="n">XSD</span><span class="o">.</span><span class="n">string</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">SPARQLError</span><span class="p">(</span><span class="s2">&quot;Cannot cast </span><span class="si">%r</span><span class="s2"> to XSD:dateTime&quot;</span> <span class="o">%</span> <span class="n">x</span><span class="o">.</span><span class="n">datatype</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Literal</span><span class="p">(</span><span class="n">isodate</span><span class="o">.</span><span class="n">parse_datetime</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">datatype</span><span class="o">=</span><span class="n">e</span><span class="o">.</span><span class="n">iri</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SPARQLError</span><span class="p">(</span><span class="s2">&quot;Cannot interpret &#39;</span><span class="si">%r</span><span class="s2">&#39; as datetime&quot;</span> <span class="o">%</span> <span class="n">x</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">datatype</span> <span class="o">==</span> <span class="n">XSD</span><span class="o">.</span><span class="n">dateTime</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">SPARQLError</span><span class="p">(</span><span class="s2">&quot;Cannot cast XSD.dateTime to </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">e</span><span class="o">.</span><span class="n">iri</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">iri</span> <span class="ow">in</span> <span class="p">(</span><span class="n">XSD</span><span class="o">.</span><span class="n">float</span><span class="p">,</span> <span class="n">XSD</span><span class="o">.</span><span class="n">double</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Literal</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">datatype</span><span class="o">=</span><span class="n">e</span><span class="o">.</span><span class="n">iri</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SPARQLError</span><span class="p">(</span><span class="s2">&quot;Cannot interpret &#39;</span><span class="si">%r</span><span class="s2">&#39; as float&quot;</span> <span class="o">%</span> <span class="n">x</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">e</span><span class="o">.</span><span class="n">iri</span> <span class="o">==</span> <span class="n">XSD</span><span class="o">.</span><span class="n">decimal</span><span class="p">:</span>
        <span class="k">if</span> <span class="s2">&quot;e&quot;</span> <span class="ow">in</span> <span class="n">x</span> <span class="ow">or</span> <span class="s2">&quot;E&quot;</span> <span class="ow">in</span> <span class="n">x</span><span class="p">:</span>  <span class="c1"># SPARQL/XSD does not allow exponents in decimals</span>
            <span class="k">raise</span> <span class="n">SPARQLError</span><span class="p">(</span><span class="s2">&quot;Cannot interpret &#39;</span><span class="si">%r</span><span class="s2">&#39; as decimal&quot;</span> <span class="o">%</span> <span class="n">x</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Literal</span><span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">datatype</span><span class="o">=</span><span class="n">e</span><span class="o">.</span><span class="n">iri</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SPARQLError</span><span class="p">(</span><span class="s2">&quot;Cannot interpret &#39;</span><span class="si">%r</span><span class="s2">&#39; as decimal&quot;</span> <span class="o">%</span> <span class="n">x</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">e</span><span class="o">.</span><span class="n">iri</span> <span class="o">==</span> <span class="n">XSD</span><span class="o">.</span><span class="n">integer</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Literal</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">datatype</span><span class="o">=</span><span class="n">XSD</span><span class="o">.</span><span class="n">integer</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SPARQLError</span><span class="p">(</span><span class="s2">&quot;Cannot interpret &#39;</span><span class="si">%r</span><span class="s2">&#39; as int&quot;</span> <span class="o">%</span> <span class="n">x</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">e</span><span class="o">.</span><span class="n">iri</span> <span class="o">==</span> <span class="n">XSD</span><span class="o">.</span><span class="n">boolean</span><span class="p">:</span>
        <span class="c1"># # I would argue that any number is True...</span>
        <span class="c1"># try:</span>
        <span class="c1">#     return Literal(bool(int(x)), datatype=XSD.boolean)</span>
        <span class="c1"># except:</span>
        <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="s2">&quot;true&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">Literal</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;0&quot;</span><span class="p">,</span> <span class="s2">&quot;false&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">Literal</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">SPARQLError</span><span class="p">(</span><span class="s2">&quot;Cannot interpret &#39;</span><span class="si">%r</span><span class="s2">&#39; as bool&quot;</span> <span class="o">%</span> <span class="n">x</span><span class="p">)</span></div>


<div class="viewcode-block" id="UnaryNot"><a class="viewcode-back" href="../../../../apidocs/rdflib.plugins.sparql.html#rdflib.plugins.sparql.operators.UnaryNot">[docs]</a><span class="k">def</span> <span class="nf">UnaryNot</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">Literal</span><span class="p">(</span><span class="ow">not</span> <span class="n">EBV</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">expr</span><span class="p">))</span></div>


<div class="viewcode-block" id="UnaryMinus"><a class="viewcode-back" href="../../../../apidocs/rdflib.plugins.sparql.html#rdflib.plugins.sparql.operators.UnaryMinus">[docs]</a><span class="k">def</span> <span class="nf">UnaryMinus</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">Literal</span><span class="p">(</span><span class="o">-</span><span class="n">numeric</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">expr</span><span class="p">))</span></div>


<div class="viewcode-block" id="UnaryPlus"><a class="viewcode-back" href="../../../../apidocs/rdflib.plugins.sparql.html#rdflib.plugins.sparql.operators.UnaryPlus">[docs]</a><span class="k">def</span> <span class="nf">UnaryPlus</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">Literal</span><span class="p">(</span><span class="o">+</span><span class="n">numeric</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">expr</span><span class="p">))</span></div>


<div class="viewcode-block" id="MultiplicativeExpression"><a class="viewcode-back" href="../../../../apidocs/rdflib.plugins.sparql.html#rdflib.plugins.sparql.operators.MultiplicativeExpression">[docs]</a><span class="k">def</span> <span class="nf">MultiplicativeExpression</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>

    <span class="n">expr</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">expr</span>
    <span class="n">other</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">other</span>

    <span class="c1"># because of the way the mul-expr production handled operator precedence</span>
    <span class="c1"># we sometimes have nothing to do</span>
    <span class="k">if</span> <span class="n">other</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">expr</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">Decimal</span><span class="p">(</span><span class="n">numeric</span><span class="p">(</span><span class="n">expr</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">op</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">op</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">numeric</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="o">==</span> <span class="nb">float</span><span class="p">:</span>
                <span class="n">res</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">op</span> <span class="o">==</span> <span class="s2">&quot;*&quot;</span><span class="p">:</span>
                <span class="n">res</span> <span class="o">*=</span> <span class="n">f</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">res</span> <span class="o">/=</span> <span class="n">f</span>
    <span class="k">except</span> <span class="p">(</span><span class="n">InvalidOperation</span><span class="p">,</span> <span class="ne">ZeroDivisionError</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">SPARQLError</span><span class="p">(</span><span class="s2">&quot;divide by 0&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">Literal</span><span class="p">(</span><span class="n">res</span><span class="p">)</span></div>


<div class="viewcode-block" id="AdditiveExpression"><a class="viewcode-back" href="../../../../apidocs/rdflib.plugins.sparql.html#rdflib.plugins.sparql.operators.AdditiveExpression">[docs]</a><span class="k">def</span> <span class="nf">AdditiveExpression</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>

    <span class="n">expr</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">expr</span>
    <span class="n">other</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">other</span>

    <span class="c1"># because of the way the add-expr production handled operator precedence</span>
    <span class="c1"># we sometimes have nothing to do</span>
    <span class="k">if</span> <span class="n">other</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">expr</span>

    <span class="c1"># handling arithmetic(addition/subtraction) of dateTime, date, time</span>
    <span class="c1"># and duration datatypes (if any)</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="s2">&quot;datatype&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span>
        <span class="n">expr</span><span class="o">.</span><span class="n">datatype</span> <span class="ow">in</span> <span class="n">XSD_DateTime_DTs</span> <span class="ow">or</span> <span class="n">expr</span><span class="o">.</span><span class="n">datatype</span> <span class="ow">in</span> <span class="n">XSD_Duration_DTs</span>
    <span class="p">):</span>

        <span class="n">res</span> <span class="o">=</span> <span class="n">dateTimeObjects</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">datatype</span>

        <span class="k">for</span> <span class="n">op</span><span class="p">,</span> <span class="n">term</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">op</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>

            <span class="c1"># check if operation is datetime,date,time operation over</span>
            <span class="c1"># another datetime,date,time datatype</span>
            <span class="k">if</span> <span class="n">dt</span> <span class="ow">in</span> <span class="n">XSD_DateTime_DTs</span> <span class="ow">and</span> <span class="n">dt</span> <span class="o">==</span> <span class="n">term</span><span class="o">.</span><span class="n">datatype</span> <span class="ow">and</span> <span class="n">op</span> <span class="o">==</span> <span class="s2">&quot;-&quot;</span><span class="p">:</span>
                <span class="c1"># checking if there are more than one datetime operands -</span>
                <span class="c1"># in that case it doesn&#39;t make sense for example</span>
                <span class="c1"># ( dateTime1 - dateTime2 - dateTime3 ) is an invalid operation</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">other</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">error_message</span> <span class="o">=</span> <span class="s2">&quot;Can&#39;t evaluate multiple </span><span class="si">%r</span><span class="s2"> arguments&quot;</span>
                    <span class="k">raise</span> <span class="n">SPARQLError</span><span class="p">(</span><span class="n">error_message</span><span class="p">,</span> <span class="n">dt</span><span class="o">.</span><span class="n">datatype</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">n</span> <span class="o">=</span> <span class="n">dateTimeObjects</span><span class="p">(</span><span class="n">term</span><span class="p">)</span>
                    <span class="n">res</span> <span class="o">=</span> <span class="n">calculateDuration</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">res</span>

            <span class="c1"># datetime,date,time +/- duration,dayTimeDuration,yearMonthDuration</span>
            <span class="k">elif</span> <span class="n">dt</span> <span class="ow">in</span> <span class="n">XSD_DateTime_DTs</span> <span class="ow">and</span> <span class="n">term</span><span class="o">.</span><span class="n">datatype</span> <span class="ow">in</span> <span class="n">XSD_Duration_DTs</span><span class="p">:</span>
                <span class="n">n</span> <span class="o">=</span> <span class="n">dateTimeObjects</span><span class="p">(</span><span class="n">term</span><span class="p">)</span>
                <span class="n">res</span> <span class="o">=</span> <span class="n">calculateFinalDateTime</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">term</span><span class="o">.</span><span class="n">datatype</span><span class="p">,</span> <span class="n">op</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">res</span>

            <span class="c1"># duration,dayTimeDuration,yearMonthDuration + datetime,date,time</span>
            <span class="k">elif</span> <span class="n">dt</span> <span class="ow">in</span> <span class="n">XSD_Duration_DTs</span> <span class="ow">and</span> <span class="n">term</span><span class="o">.</span><span class="n">datatype</span> <span class="ow">in</span> <span class="n">XSD_DateTime_DTs</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">op</span> <span class="o">==</span> <span class="s2">&quot;+&quot;</span><span class="p">:</span>
                    <span class="n">n</span> <span class="o">=</span> <span class="n">dateTimeObjects</span><span class="p">(</span><span class="n">term</span><span class="p">)</span>
                    <span class="n">res</span> <span class="o">=</span> <span class="n">calculateFinalDateTime</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">term</span><span class="o">.</span><span class="n">datatype</span><span class="p">,</span> <span class="n">op</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">res</span>

            <span class="c1"># rest are invalid types</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">SPARQLError</span><span class="p">(</span><span class="s2">&quot;Invalid DateTime Operations&quot;</span><span class="p">)</span>

    <span class="c1"># handling arithmetic(addition/subtraction) of numeric datatypes (if any)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">numeric</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span>

        <span class="n">dt</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">datatype</span>

        <span class="k">for</span> <span class="n">op</span><span class="p">,</span> <span class="n">term</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">op</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">numeric</span><span class="p">(</span><span class="n">term</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">Decimal</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
                <span class="n">n</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">Decimal</span><span class="p">):</span>
                <span class="n">res</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>

            <span class="n">dt</span> <span class="o">=</span> <span class="n">type_promotion</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="n">term</span><span class="o">.</span><span class="n">datatype</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">op</span> <span class="o">==</span> <span class="s2">&quot;+&quot;</span><span class="p">:</span>
                <span class="n">res</span> <span class="o">+=</span> <span class="n">n</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">res</span> <span class="o">-=</span> <span class="n">n</span>

        <span class="k">return</span> <span class="n">Literal</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">datatype</span><span class="o">=</span><span class="n">dt</span><span class="p">)</span></div>


<div class="viewcode-block" id="RelationalExpression"><a class="viewcode-back" href="../../../../apidocs/rdflib.plugins.sparql.html#rdflib.plugins.sparql.operators.RelationalExpression">[docs]</a><span class="k">def</span> <span class="nf">RelationalExpression</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>

    <span class="n">expr</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">expr</span>
    <span class="n">other</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">other</span>
    <span class="n">op</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">op</span>

    <span class="c1"># because of the way the add-expr production handled operator precedence</span>
    <span class="c1"># we sometimes have nothing to do</span>
    <span class="k">if</span> <span class="n">other</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">expr</span>

    <span class="n">ops</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="p">(</span><span class="s2">&quot;&gt;&quot;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="fm">__gt__</span><span class="p">(</span><span class="n">y</span><span class="p">)),</span>
            <span class="p">(</span><span class="s2">&quot;&lt;&quot;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="fm">__lt__</span><span class="p">(</span><span class="n">y</span><span class="p">)),</span>
            <span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="n">y</span><span class="p">)),</span>
            <span class="p">(</span><span class="s2">&quot;!=&quot;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">neq</span><span class="p">(</span><span class="n">y</span><span class="p">)),</span>
            <span class="p">(</span><span class="s2">&quot;&gt;=&quot;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="fm">__ge__</span><span class="p">(</span><span class="n">y</span><span class="p">)),</span>
            <span class="p">(</span><span class="s2">&quot;&lt;=&quot;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="fm">__le__</span><span class="p">(</span><span class="n">y</span><span class="p">)),</span>
            <span class="p">(</span><span class="s2">&quot;IN&quot;</span><span class="p">,</span> <span class="n">pyop</span><span class="o">.</span><span class="n">contains</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;NOT IN&quot;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="ow">not</span> <span class="n">pyop</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)),</span>
        <span class="p">]</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">op</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;IN&quot;</span><span class="p">,</span> <span class="s2">&quot;NOT IN&quot;</span><span class="p">):</span>

        <span class="n">res</span> <span class="o">=</span> <span class="n">op</span> <span class="o">==</span> <span class="s2">&quot;NOT IN&quot;</span>

        <span class="n">error</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">other</span> <span class="o">==</span> <span class="n">RDF</span><span class="o">.</span><span class="n">nil</span><span class="p">:</span>
            <span class="n">other</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">other</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="n">expr</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">Literal</span><span class="p">(</span><span class="kc">True</span> <span class="o">^</span> <span class="n">res</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">SPARQLError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">error</span> <span class="o">=</span> <span class="n">e</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">error</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Literal</span><span class="p">(</span><span class="kc">False</span> <span class="o">^</span> <span class="n">res</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">error</span>

    <span class="k">if</span> <span class="n">op</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">,</span> <span class="s2">&quot;!=&quot;</span><span class="p">,</span> <span class="s2">&quot;IN&quot;</span><span class="p">,</span> <span class="s2">&quot;NOT IN&quot;</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">Literal</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">SPARQLError</span><span class="p">(</span>
                <span class="s2">&quot;Compare other than =, != of non-literals is an error: </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">expr</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">Literal</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">SPARQLError</span><span class="p">(</span>
                <span class="s2">&quot;Compare other than =, != of non-literals is an error: </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">other</span>
            <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">Node</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">SPARQLError</span><span class="p">(</span><span class="s2">&quot;I cannot compare this non-node: </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">expr</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">Node</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">SPARQLError</span><span class="p">(</span><span class="s2">&quot;I cannot compare this non-node: </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">other</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">Literal</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">Literal</span><span class="p">):</span>

        <span class="k">if</span> <span class="p">(</span>
            <span class="n">expr</span><span class="o">.</span><span class="n">datatype</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="ow">and</span> <span class="n">expr</span><span class="o">.</span><span class="n">datatype</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">XSD_DTs</span>
            <span class="ow">and</span> <span class="n">other</span><span class="o">.</span><span class="n">datatype</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="ow">and</span> <span class="n">other</span><span class="o">.</span><span class="n">datatype</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">XSD_DTs</span>
        <span class="p">):</span>
            <span class="c1"># in SPARQL for non-XSD DT Literals we can only do =,!=</span>
            <span class="k">if</span> <span class="n">op</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">,</span> <span class="s2">&quot;!=&quot;</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">SPARQLError</span><span class="p">(</span><span class="s2">&quot;Can only do =,!= comparisons of non-XSD Literals&quot;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">ops</span><span class="p">[</span><span class="n">op</span><span class="p">](</span><span class="n">expr</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">r</span> <span class="o">==</span> <span class="bp">NotImplemented</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SPARQLError</span><span class="p">(</span><span class="s2">&quot;Error when comparing&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">TypeError</span> <span class="k">as</span> <span class="n">te</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">SPARQLError</span><span class="p">(</span><span class="o">*</span><span class="n">te</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">Literal</span><span class="p">(</span><span class="n">r</span><span class="p">)</span></div>


<div class="viewcode-block" id="ConditionalAndExpression"><a class="viewcode-back" href="../../../../apidocs/rdflib.plugins.sparql.html#rdflib.plugins.sparql.operators.ConditionalAndExpression">[docs]</a><span class="k">def</span> <span class="nf">ConditionalAndExpression</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>

    <span class="c1"># TODO: handle returned errors</span>

    <span class="n">expr</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">expr</span>
    <span class="n">other</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">other</span>

    <span class="c1"># because of the way the add-expr production handled operator precedence</span>
    <span class="c1"># we sometimes have nothing to do</span>
    <span class="k">if</span> <span class="n">other</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">expr</span>

    <span class="k">return</span> <span class="n">Literal</span><span class="p">(</span><span class="nb">all</span><span class="p">(</span><span class="n">EBV</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[</span><span class="n">expr</span><span class="p">]</span> <span class="o">+</span> <span class="n">other</span><span class="p">))</span></div>


<div class="viewcode-block" id="ConditionalOrExpression"><a class="viewcode-back" href="../../../../apidocs/rdflib.plugins.sparql.html#rdflib.plugins.sparql.operators.ConditionalOrExpression">[docs]</a><span class="k">def</span> <span class="nf">ConditionalOrExpression</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>

    <span class="c1"># TODO: handle errors</span>

    <span class="n">expr</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">expr</span>
    <span class="n">other</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">other</span>

    <span class="c1"># because of the way the add-expr production handled operator precedence</span>
    <span class="c1"># we sometimes have nothing to do</span>
    <span class="k">if</span> <span class="n">other</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">expr</span>
    <span class="c1"># A logical-or that encounters an error on only one branch</span>
    <span class="c1"># will return TRUE if the other branch is TRUE and an error</span>
    <span class="c1"># if the other branch is FALSE.</span>
    <span class="n">error</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[</span><span class="n">expr</span><span class="p">]</span> <span class="o">+</span> <span class="n">other</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">EBV</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">Literal</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">SPARQLError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">error</span> <span class="o">=</span> <span class="n">e</span>
    <span class="k">if</span> <span class="n">error</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">error</span>
    <span class="k">return</span> <span class="n">Literal</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span></div>


<div class="viewcode-block" id="not_"><a class="viewcode-back" href="../../../../apidocs/rdflib.plugins.sparql.html#rdflib.plugins.sparql.operators.not_">[docs]</a><span class="k">def</span> <span class="nf">not_</span><span class="p">(</span><span class="n">arg</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">Expr</span><span class="p">(</span><span class="s2">&quot;UnaryNot&quot;</span><span class="p">,</span> <span class="n">UnaryNot</span><span class="p">,</span> <span class="n">expr</span><span class="o">=</span><span class="n">arg</span><span class="p">)</span></div>


<div class="viewcode-block" id="and_"><a class="viewcode-back" href="../../../../apidocs/rdflib.plugins.sparql.html#rdflib.plugins.sparql.operators.and_">[docs]</a><span class="k">def</span> <span class="nf">and_</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">Expr</span><span class="p">(</span>
        <span class="s2">&quot;ConditionalAndExpression&quot;</span><span class="p">,</span>
        <span class="n">ConditionalAndExpression</span><span class="p">,</span>
        <span class="n">expr</span><span class="o">=</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="n">other</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">:]),</span>
    <span class="p">)</span></div>


<span class="n">TrueFilter</span> <span class="o">=</span> <span class="n">Expr</span><span class="p">(</span><span class="s2">&quot;TrueFilter&quot;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">_1</span><span class="p">,</span> <span class="n">_2</span><span class="p">:</span> <span class="n">Literal</span><span class="p">(</span><span class="kc">True</span><span class="p">))</span>


<div class="viewcode-block" id="simplify"><a class="viewcode-back" href="../../../../apidocs/rdflib.plugins.sparql.html#rdflib.plugins.sparql.operators.simplify">[docs]</a><span class="k">def</span> <span class="nf">simplify</span><span class="p">(</span><span class="n">expr</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">ParseResults</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">simplify</span><span class="p">(</span><span class="n">expr</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">ParseResults</span><span class="p">)):</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">simplify</span><span class="p">,</span> <span class="n">expr</span><span class="p">))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">CompValue</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">expr</span>
    <span class="k">if</span> <span class="n">expr</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;Expression&quot;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">expr</span><span class="o">.</span><span class="n">other</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">simplify</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">expr</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">expr</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">expr</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">simplify</span><span class="p">(</span><span class="n">expr</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
        <span class="c1"># expr[&#39;expr&#39;]=simplify(expr.expr)</span>
        <span class="c1">#    expr[&#39;other&#39;]=simplify(expr.other)</span>

    <span class="k">return</span> <span class="n">expr</span></div>


<div class="viewcode-block" id="literal"><a class="viewcode-back" href="../../../../apidocs/rdflib.plugins.sparql.html#rdflib.plugins.sparql.operators.literal">[docs]</a><span class="k">def</span> <span class="nf">literal</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">Literal</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">SPARQLError</span><span class="p">(</span><span class="s2">&quot;Non-literal passed as string: </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">s</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">s</span></div>


<div class="viewcode-block" id="datetime"><a class="viewcode-back" href="../../../../apidocs/rdflib.plugins.sparql.html#rdflib.plugins.sparql.operators.datetime">[docs]</a><span class="k">def</span> <span class="nf">datetime</span><span class="p">(</span><span class="n">e</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">Literal</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">SPARQLError</span><span class="p">(</span><span class="s2">&quot;Non-literal passed as datetime: </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">e</span><span class="o">.</span><span class="n">datatype</span> <span class="o">==</span> <span class="n">XSD</span><span class="o">.</span><span class="n">dateTime</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">SPARQLError</span><span class="p">(</span><span class="s2">&quot;Literal with wrong datatype passed as datetime: </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">e</span><span class="o">.</span><span class="n">toPython</span><span class="p">()</span></div>


<div class="viewcode-block" id="date"><a class="viewcode-back" href="../../../../apidocs/rdflib.plugins.sparql.html#rdflib.plugins.sparql.operators.date">[docs]</a><span class="k">def</span> <span class="nf">date</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">py_datetime</span><span class="o">.</span><span class="n">date</span><span class="p">:</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">Literal</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">SPARQLError</span><span class="p">(</span><span class="s2">&quot;Non-literal passed as date: </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">datatype</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="n">XSD</span><span class="o">.</span><span class="n">date</span><span class="p">,</span> <span class="n">XSD</span><span class="o">.</span><span class="n">dateTime</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">SPARQLError</span><span class="p">(</span><span class="s2">&quot;Literal with wrong datatype passed as date: </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">toPython</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">py_datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">result</span></div>


<div class="viewcode-block" id="string"><a class="viewcode-back" href="../../../../apidocs/rdflib.plugins.sparql.html#rdflib.plugins.sparql.operators.string">[docs]</a><span class="k">def</span> <span class="nf">string</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Make sure the passed thing is a string literal</span>
<span class="sd">    i.e. plain literal, xsd:string literal or lang-tagged literal</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">Literal</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">SPARQLError</span><span class="p">(</span><span class="s2">&quot;Non-literal passes as string: </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">s</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">datatype</span> <span class="ow">and</span> <span class="n">s</span><span class="o">.</span><span class="n">datatype</span> <span class="o">!=</span> <span class="n">XSD</span><span class="o">.</span><span class="n">string</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">SPARQLError</span><span class="p">(</span><span class="s2">&quot;Non-string datatype-literal passes as string: </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">s</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">s</span></div>


<div class="viewcode-block" id="numeric"><a class="viewcode-back" href="../../../../apidocs/rdflib.plugins.sparql.html#rdflib.plugins.sparql.operators.numeric">[docs]</a><span class="k">def</span> <span class="nf">numeric</span><span class="p">(</span><span class="n">expr</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    return a number from a literal</span>
<span class="sd">    http://www.w3.org/TR/xpath20/#promotion</span>

<span class="sd">    or TypeError</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">Literal</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">SPARQLTypeError</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%r</span><span class="s2"> is not a literal!&quot;</span> <span class="o">%</span> <span class="n">expr</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">expr</span><span class="o">.</span><span class="n">datatype</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span>
        <span class="n">XSD</span><span class="o">.</span><span class="n">float</span><span class="p">,</span>
        <span class="n">XSD</span><span class="o">.</span><span class="n">double</span><span class="p">,</span>
        <span class="n">XSD</span><span class="o">.</span><span class="n">decimal</span><span class="p">,</span>
        <span class="n">XSD</span><span class="o">.</span><span class="n">integer</span><span class="p">,</span>
        <span class="n">XSD</span><span class="o">.</span><span class="n">nonPositiveInteger</span><span class="p">,</span>
        <span class="n">XSD</span><span class="o">.</span><span class="n">negativeInteger</span><span class="p">,</span>
        <span class="n">XSD</span><span class="o">.</span><span class="n">nonNegativeInteger</span><span class="p">,</span>
        <span class="n">XSD</span><span class="o">.</span><span class="n">positiveInteger</span><span class="p">,</span>
        <span class="n">XSD</span><span class="o">.</span><span class="n">unsignedLong</span><span class="p">,</span>
        <span class="n">XSD</span><span class="o">.</span><span class="n">unsignedInt</span><span class="p">,</span>
        <span class="n">XSD</span><span class="o">.</span><span class="n">unsignedShort</span><span class="p">,</span>
        <span class="n">XSD</span><span class="o">.</span><span class="n">unsignedByte</span><span class="p">,</span>
        <span class="n">XSD</span><span class="o">.</span><span class="n">long</span><span class="p">,</span>
        <span class="n">XSD</span><span class="o">.</span><span class="n">int</span><span class="p">,</span>
        <span class="n">XSD</span><span class="o">.</span><span class="n">short</span><span class="p">,</span>
        <span class="n">XSD</span><span class="o">.</span><span class="n">byte</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="k">raise</span> <span class="n">SPARQLTypeError</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%r</span><span class="s2"> does not have a numeric datatype!&quot;</span> <span class="o">%</span> <span class="n">expr</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">expr</span><span class="o">.</span><span class="n">toPython</span><span class="p">()</span></div>


<div class="viewcode-block" id="dateTimeObjects"><a class="viewcode-back" href="../../../../apidocs/rdflib.plugins.sparql.html#rdflib.plugins.sparql.operators.dateTimeObjects">[docs]</a><span class="k">def</span> <span class="nf">dateTimeObjects</span><span class="p">(</span><span class="n">expr</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    return a dataTime/date/time/duration/dayTimeDuration/yearMonthDuration python objects from a literal</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">expr</span><span class="o">.</span><span class="n">toPython</span><span class="p">()</span></div>


<div class="viewcode-block" id="isCompatibleDateTimeDatatype"><a class="viewcode-back" href="../../../../apidocs/rdflib.plugins.sparql.html#rdflib.plugins.sparql.operators.isCompatibleDateTimeDatatype">[docs]</a><span class="k">def</span> <span class="nf">isCompatibleDateTimeDatatype</span><span class="p">(</span><span class="n">obj1</span><span class="p">,</span> <span class="n">dt1</span><span class="p">,</span> <span class="n">obj2</span><span class="p">,</span> <span class="n">dt2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns a boolean indicating if first object is compatible</span>
<span class="sd">    with operation(+/-) over second object.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">dt1</span> <span class="o">==</span> <span class="n">XSD</span><span class="o">.</span><span class="n">date</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">dt2</span> <span class="o">==</span> <span class="n">XSD</span><span class="o">.</span><span class="n">yearMonthDuration</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="n">dt2</span> <span class="o">==</span> <span class="n">XSD</span><span class="o">.</span><span class="n">dayTimeDuration</span> <span class="ow">or</span> <span class="n">dt2</span> <span class="o">==</span> <span class="n">XSD</span><span class="o">.</span><span class="n">Duration</span><span class="p">:</span>
            <span class="c1"># checking if the dayTimeDuration has no Time Component</span>
            <span class="c1"># else it wont be compatible with Date Literal</span>
            <span class="k">if</span> <span class="s2">&quot;T&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">obj2</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>

    <span class="k">if</span> <span class="n">dt1</span> <span class="o">==</span> <span class="n">XSD</span><span class="o">.</span><span class="n">time</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">dt2</span> <span class="o">==</span> <span class="n">XSD</span><span class="o">.</span><span class="n">yearMonthDuration</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">elif</span> <span class="n">dt2</span> <span class="o">==</span> <span class="n">XSD</span><span class="o">.</span><span class="n">dayTimeDuration</span> <span class="ow">or</span> <span class="n">dt2</span> <span class="o">==</span> <span class="n">XSD</span><span class="o">.</span><span class="n">Duration</span><span class="p">:</span>
            <span class="c1"># checking if the dayTimeDuration has no Date Component</span>
            <span class="c1"># (by checking if the format is &quot;PT....&quot; )</span>
            <span class="c1"># else it wont be compatible with Time Literal</span>
            <span class="k">if</span> <span class="s2">&quot;T&quot;</span> <span class="o">==</span> <span class="nb">str</span><span class="p">(</span><span class="n">obj2</span><span class="p">)[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>

    <span class="k">if</span> <span class="n">dt1</span> <span class="o">==</span> <span class="n">XSD</span><span class="o">.</span><span class="n">dateTime</span><span class="p">:</span>
        <span class="c1"># compatible with all</span>
        <span class="k">return</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="calculateDuration"><a class="viewcode-back" href="../../../../apidocs/rdflib.plugins.sparql.html#rdflib.plugins.sparql.operators.calculateDuration">[docs]</a><span class="k">def</span> <span class="nf">calculateDuration</span><span class="p">(</span><span class="n">obj1</span><span class="p">,</span> <span class="n">obj2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    returns the duration Literal between two datetime</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">date1</span> <span class="o">=</span> <span class="n">obj1</span>
    <span class="n">date2</span> <span class="o">=</span> <span class="n">obj2</span>
    <span class="n">difference</span> <span class="o">=</span> <span class="n">date1</span> <span class="o">-</span> <span class="n">date2</span>
    <span class="k">return</span> <span class="n">Literal</span><span class="p">(</span><span class="n">difference</span><span class="p">,</span> <span class="n">datatype</span><span class="o">=</span><span class="n">XSD</span><span class="o">.</span><span class="n">duration</span><span class="p">)</span></div>


<div class="viewcode-block" id="calculateFinalDateTime"><a class="viewcode-back" href="../../../../apidocs/rdflib.plugins.sparql.html#rdflib.plugins.sparql.operators.calculateFinalDateTime">[docs]</a><span class="k">def</span> <span class="nf">calculateFinalDateTime</span><span class="p">(</span><span class="n">obj1</span><span class="p">,</span> <span class="n">dt1</span><span class="p">,</span> <span class="n">obj2</span><span class="p">,</span> <span class="n">dt2</span><span class="p">,</span> <span class="n">operation</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates the final dateTime/date/time resultant after addition/</span>
<span class="sd">    subtraction of duration/dayTimeDuration/yearMonthDuration</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># checking compatibility of datatypes (duration types and date/time/dateTime)</span>
    <span class="k">if</span> <span class="n">isCompatibleDateTimeDatatype</span><span class="p">(</span><span class="n">obj1</span><span class="p">,</span> <span class="n">dt1</span><span class="p">,</span> <span class="n">obj2</span><span class="p">,</span> <span class="n">dt2</span><span class="p">):</span>
        <span class="c1"># proceed</span>
        <span class="k">if</span> <span class="n">operation</span> <span class="o">==</span> <span class="s2">&quot;-&quot;</span><span class="p">:</span>
            <span class="n">ans</span> <span class="o">=</span> <span class="n">obj1</span> <span class="o">-</span> <span class="n">obj2</span>
            <span class="k">return</span> <span class="n">Literal</span><span class="p">(</span><span class="n">ans</span><span class="p">,</span> <span class="n">datatype</span><span class="o">=</span><span class="n">dt1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ans</span> <span class="o">=</span> <span class="n">obj1</span> <span class="o">+</span> <span class="n">obj2</span>
            <span class="k">return</span> <span class="n">Literal</span><span class="p">(</span><span class="n">ans</span><span class="p">,</span> <span class="n">datatype</span><span class="o">=</span><span class="n">dt1</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">SPARQLError</span><span class="p">(</span><span class="s2">&quot;Incompatible Data types to DateTime Operations&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="EBV"><a class="viewcode-back" href="../../../../apidocs/rdflib.plugins.sparql.html#rdflib.plugins.sparql.operators.EBV">[docs]</a><span class="k">def</span> <span class="nf">EBV</span><span class="p">(</span><span class="n">rt</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Effective Boolean Value (EBV)</span>

<span class="sd">    * If the argument is a typed literal with a datatype of xsd:boolean,</span>
<span class="sd">      the EBV is the value of that argument.</span>
<span class="sd">    * If the argument is a plain literal or a typed literal with a</span>
<span class="sd">      datatype of xsd:string, the EBV is false if the operand value</span>
<span class="sd">      has zero length; otherwise the EBV is true.</span>
<span class="sd">    * If the argument is a numeric type or a typed literal with a datatype</span>
<span class="sd">      derived from a numeric type, the EBV is false if the operand value is</span>
<span class="sd">      NaN or is numerically equal to zero; otherwise the EBV is true.</span>
<span class="sd">    * All other arguments, including unbound arguments, produce a type error.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rt</span><span class="p">,</span> <span class="n">Literal</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">rt</span><span class="o">.</span><span class="n">datatype</span> <span class="o">==</span> <span class="n">XSD</span><span class="o">.</span><span class="n">boolean</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">rt</span><span class="o">.</span><span class="n">toPython</span><span class="p">()</span>

        <span class="k">elif</span> <span class="n">rt</span><span class="o">.</span><span class="n">datatype</span> <span class="o">==</span> <span class="n">XSD</span><span class="o">.</span><span class="n">string</span> <span class="ow">or</span> <span class="n">rt</span><span class="o">.</span><span class="n">datatype</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">rt</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">pyRT</span> <span class="o">=</span> <span class="n">rt</span><span class="o">.</span><span class="n">toPython</span><span class="p">()</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pyRT</span><span class="p">,</span> <span class="n">Literal</span><span class="p">):</span>
                <span class="c1"># Type error, see: http://www.w3.org/TR/rdf-sparql-query/#ebv</span>
                <span class="k">raise</span> <span class="n">SPARQLTypeError</span><span class="p">(</span>
                    <span class="s2">&quot;http://www.w3.org/TR/rdf-sparql-query/#ebv - &#39; + </span><span class="se">\</span>
<span class="s2">                    &#39;Could not determine the EBV for : </span><span class="si">%r</span><span class="s2">&quot;</span>
                    <span class="o">%</span> <span class="n">rt</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="n">pyRT</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">SPARQLTypeError</span><span class="p">(</span>
            <span class="s2">&quot;http://www.w3.org/TR/rdf-sparql-query/#ebv - &#39; + </span><span class="se">\</span>
<span class="s2">            &#39;Only literals have Boolean values! </span><span class="si">%r</span><span class="s2">&quot;</span>
            <span class="o">%</span> <span class="n">rt</span>
        <span class="p">)</span></div>


<span class="k">def</span> <span class="nf">_lang_range_check</span><span class="p">(</span><span class="nb">range</span><span class="p">,</span> <span class="n">lang</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Implementation of the extended filtering algorithm, as defined in point</span>
<span class="sd">    3.3.2, of U{RFC 4647&lt;http://www.rfc-editor.org/rfc/rfc4647.txt&gt;}, on</span>
<span class="sd">    matching language ranges and language tags.</span>
<span class="sd">    Needed to handle the C{rdf:PlainLiteral} datatype.</span>
<span class="sd">    @param range: language range</span>
<span class="sd">    @param lang: language tag</span>
<span class="sd">    @rtype: boolean</span>

<span class="sd">        @author: U{Ivan Herman&lt;a href=&quot;http://www.w3.org/People/Ivan/&quot;&gt;}</span>

<span class="sd">        Taken from `RDFClosure/RestrictedDatatype.py`__</span>

<span class="sd">    .. __:http://dev.w3.org/2004/PythonLib-IH/RDFClosure/RestrictedDatatype.py</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">_match</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">l_</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Matching of a range and language item: either range is a wildcard</span>
<span class="sd">        or the two are equal</span>
<span class="sd">        @param r: language range item</span>
<span class="sd">        @param l_: language tag item</span>
<span class="sd">        @rtype: boolean</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">r</span> <span class="o">==</span> <span class="s2">&quot;*&quot;</span> <span class="ow">or</span> <span class="n">r</span> <span class="o">==</span> <span class="n">l_</span>

    <span class="n">rangeList</span> <span class="o">=</span> <span class="nb">range</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">)</span>
    <span class="n">langList</span> <span class="o">=</span> <span class="n">lang</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">_match</span><span class="p">(</span><span class="n">rangeList</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">langList</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rangeList</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">langList</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="n">_match</span><span class="p">(</span><span class="o">*</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">rangeList</span><span class="p">,</span> <span class="n">langList</span><span class="p">))</span>
</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../../../index.html">
              <img class="logo" src="../../../../_static/RDFlib.png" alt="Logo"/>
            </a></p>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../../index.html">rdflib 6.2.0-alpha documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../../index.html" >Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">rdflib.plugins.sparql.operators</a></li> 
      </ul>
    </div>
<div class="footer">
    &copy; Copyright 2009 - 2021, RDFLib Team.
  Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 4.3.2.
  <br />Theme based on <a href="http://readthedocs.org/">Read The Docs</a>

</div>





  </body>
</html>